// Database Schema for Chatter Application
// Updated to match actual SQLModel implementation

Table user {
  id int [pk, increment]
  username varchar [unique, not null]
  firstname varchar [not null]
  lastname varchar [not null]
  date_of_birth datetime
  email varchar [unique, not null]
  status varchar [not null, default: 'active'] // active or inactive
  hashed_password varchar [not null]
  type int [default: 0] // 0 = regular user, 1 = admin
  force_password_reset boolean [default: false] // Admin can force password reset on next login
  password_reset_code varchar // One-time code for password reset (generated by admin)
  code_expires_at timestamp // Expiration timestamp for reset code (24 hours from generation)
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  last_login timestamp // Last login time for engagement tracking
  profile_picture varchar // Filename of profile picture stored on NAS (Issue #44)
  location varchar // User's location for timezone/localization (Issue #44)
  bio text // Short biography/about me text (Issue #44)
}

table accountlog {
  id int [pk, increment]
  user_id int [not null]
  action varchar [not null] // created, updated, activated, deactivated, deleted
  field_changed varchar // specific field that was changed
  old_value varchar // previous value
  new_value varchar // new value
  changed_by int // user_id of who made the change
  changed_at timestamp [default: `now()`]
  ip_address varchar
  user_agent varchar
}

table like {
  id int [pk, increment]
  url varchar [not null]
  user_id int [not null]
}

table comment {
  id int [pk, increment]
  url varchar [not null]
  content varchar [not null]
  created_at timestamp [default: `now()`]
  edited_at timestamp // When comment was last edited
  user_id int [not null]
  is_flagged boolean [default: false] // Whether comment has been flagged for review
  flag_count int [default: 0] // Number of times comment has been reported
  flag_reasons text // JSON string of report reasons
  is_hidden boolean [default: false] // Admin can hide abusive comments
  reviewed_at timestamp // When admin reviewed the flagged comment
  reviewed_by int // Admin who reviewed the comment
  is_removed boolean [default: false] // User soft-deleted their own comment
  removed_at timestamp // When comment was removed by author
}

table commentversion {
  id int [pk, increment]
  comment_id int [not null]
  content text [not null] // Previous version of comment content
  edited_at timestamp [default: `now()`] // When this version was created
}

table pageview {
  id int [pk, increment]
  url varchar [not null]
  ip_address varchar [not null]
  viewed_at timestamp [default: `now()`]
  user_agent text
}

table projects {
  id int [pk, increment]
  title varchar
  author int
}

table steps {
  id int [pk, increment]
  project_id int
}

table media {
  id int [pk, increment]
  filename varchar
  project_id int
}

// Relationships
Ref: accountlog.user_id > user.id [delete: cascade]
Ref: accountlog.changed_by > user.id [delete: set null]
Ref: like.user_id > user.id [delete: cascade]
Ref: comment.user_id > user.id [delete: cascade]
Ref: comment.reviewed_by > user.id [delete: set null]
Ref: commentversion.comment_id > comment.id [delete: cascade]
Ref: projects.author > user.id
Ref: steps.project_id > projects.id
Ref: media.project_id > projects.id

// Notes
// pageview table tracks all page visits for analytics
// Materialized view page_view_counts aggregates view counts by URL for performance (requires manual refresh)
// View top_viewed_pages shows the top 10 most viewed pages ordered by view count (queries pageview table directly for real-time data)
