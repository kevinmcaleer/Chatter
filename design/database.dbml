// Database Schema for Chatter Application
// Updated to match actual SQLModel implementation

Table user {
  id int [pk, increment]
  username varchar [unique, not null]
  firstname varchar [not null]
  lastname varchar [not null]
  date_of_birth datetime
  email varchar [unique, not null]
  status varchar [not null, default: 'active'] // active or inactive
  hashed_password varchar [not null]
  type int [default: 0] // 0 = regular user, 1 = admin
  force_password_reset boolean [default: false] // Admin can force password reset on next login
  password_reset_code varchar // One-time code for password reset (generated by admin)
  code_expires_at timestamp // Expiration timestamp for reset code (24 hours from generation)
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  last_login timestamp // Last login time for engagement tracking
  profile_picture varchar // Filename of profile picture stored on NAS (Issue #44)
  location varchar // User's location for timezone/localization (Issue #44)
  bio text // Short biography/about me text (Issue #44)
}

table accountlog {
  id int [pk, increment]
  user_id int [not null]
  action varchar [not null] // created, updated, activated, deactivated, deleted
  field_changed varchar // specific field that was changed
  old_value varchar // previous value
  new_value varchar // new value
  changed_by int // user_id of who made the change
  changed_at timestamp [default: `now()`]
  ip_address varchar
  user_agent varchar
}

table like {
  id int [pk, increment]
  url varchar // For URL-based content (blog posts) - nullable
  entity_type varchar(50) // For entity-based content (e.g., "project") - nullable
  entity_id int // ID of entity being liked - nullable
  user_id int [not null]
  created_at timestamp [not null, default: `now()`]

  Note: '''
  Either url OR (entity_type + entity_id) must be provided, not both.
  Enforced via check constraint: like_target_check
  Unique constraints:
  - idx_like_user_url: unique (user_id, url) WHERE url IS NOT NULL
  - idx_like_user_entity: unique (user_id, entity_type, entity_id) WHERE entity_type IS NOT NULL
  '''

  Indexes {
    user_id
    url
    (entity_type, entity_id) [where: 'entity_type IS NOT NULL']
  }
}

table comment {
  id int [pk, increment]
  url varchar // For URL-based content (blog posts) - nullable
  entity_type varchar(50) // For entity-based content (e.g., "project") - nullable
  entity_id int // ID of entity being commented on - nullable
  content varchar [not null]
  created_at timestamp [default: `now()`]
  edited_at timestamp // When comment was last edited
  user_id int [not null]
  is_flagged boolean [default: false] // Whether comment has been flagged for review
  flag_count int [default: 0] // Number of times comment has been reported
  flag_reasons text // JSON string of report reasons
  is_hidden boolean [default: false] // Admin can hide abusive comments
  reviewed_at timestamp // When admin reviewed the flagged comment
  reviewed_by int // Admin who reviewed the comment
  is_removed boolean [default: false] // User soft-deleted their own comment
  removed_at timestamp // When comment was removed by author
  like_count int [default: 0] // Denormalized like count for efficient sorting
  parent_comment_id int // For comment threading/replies
  reply_count int [default: 0] // Denormalized count of direct replies

  Note: '''
  Either url OR (entity_type + entity_id) must be provided, not both.
  Enforced via check constraint: comment_target_check
  '''

  Indexes {
    user_id
    url
    (entity_type, entity_id) [where: 'entity_type IS NOT NULL']
    parent_comment_id
    like_count
  }
}

table commentversion {
  id int [pk, increment]
  comment_id int [not null]
  content text [not null] // Previous version of comment content
  edited_at timestamp [default: `now()`] // When this version was created
}

table pageview {
  id int [pk, increment]
  url varchar [not null]
  ip_address varchar [not null]
  viewed_at timestamp [default: `now()`]
  user_agent text
}

table commentlike {
  id int [pk, increment]
  comment_id int [not null]
  user_id int [not null]
  created_at timestamp [default: `now()`]

  indexes {
    (comment_id, user_id) [unique]
  }
}

// User Projects - Issue #15
table project {
  id int [pk, increment]
  title varchar [not null]
  description text [not null]
  author_id int [not null]
  status varchar [not null, default: 'draft'] // 'draft' or 'published'
  background text // Markdown content for project story
  code_link varchar // URL to GitHub/code repository
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  primary_image_id int // Foreign key to project_image
  view_count int [default: 0]
  download_count int [default: 0]
  like_count int [default: 0]
  comment_count int [default: 0]
}

table project_tag {
  id int [pk, increment]
  project_id int [not null]
  tag_name varchar [not null] // Lowercase, user-defined

  indexes {
    (project_id, tag_name) [unique]
  }
}

table project_step {
  id int [pk, increment]
  project_id int [not null]
  step_number int [not null]
  title varchar [not null]
  content text [not null] // Markdown
  created_at timestamp [default: `now()`]

  indexes {
    (project_id, step_number) [unique]
  }
}

table bill_of_material {
  id int [pk, increment]
  project_id int [not null]
  item_name varchar [not null]
  description text
  quantity int [not null, default: 1]
  price_cents int // Price in cents, nullable
  item_order int [not null, default: 0]
}

table component {
  id int [pk, increment]
  name varchar [unique, not null] // Reusable component names
  description text
  datasheet_url varchar
  created_at timestamp [default: `now()`]
}

table project_component {
  id int [pk, increment]
  project_id int [not null]
  component_id int [not null]
  quantity int [not null, default: 1]
  notes text

  indexes {
    (project_id, component_id) [unique]
  }
}

table project_file {
  id int [pk, increment]
  project_id int [not null]
  filename varchar [not null]
  original_filename varchar [not null]
  file_size int [not null] // Size in bytes
  file_type varchar // MIME type
  description text
  uploaded_at timestamp [default: `now()`]
}

table project_image {
  id int [pk, increment]
  project_id int [not null]
  filename varchar [not null]
  original_filename varchar [not null]
  display_order int [not null, default: 0]
  caption text
  uploaded_at timestamp [default: `now()`]

  indexes {
    (project_id, display_order)
  }
}

table project_link {
  id int [pk, increment]
  project_id int [not null]
  url varchar [not null]
  title varchar [not null]
  link_type varchar [not null] // 'resource', 'video', 'course', 'article', 'related_project'
  description text
}

table tool_material {
  id int [pk, increment]
  project_id int [not null]
  name varchar [not null]
  tool_type varchar [not null] // 'tool' or 'material'
  notes text
}

// Relationships
Ref: accountlog.user_id > user.id [delete: cascade]
Ref: accountlog.changed_by > user.id [delete: set null]
Ref: like.user_id > user.id [delete: cascade]
Ref: comment.user_id > user.id [delete: cascade]
Ref: comment.reviewed_by > user.id [delete: set null]
Ref: commentversion.comment_id > comment.id [delete: cascade]
Ref: commentlike.comment_id > comment.id [delete: cascade]
Ref: commentlike.user_id > user.id [delete: cascade]
Ref: project.author_id > user.id [delete: cascade]
Ref: project.primary_image_id > project_image.id [delete: set null]
Ref: project_tag.project_id > project.id [delete: cascade]
Ref: project_step.project_id > project.id [delete: cascade]
Ref: bill_of_material.project_id > project.id [delete: cascade]
Ref: project_component.project_id > project.id [delete: cascade]
Ref: project_component.component_id > component.id [delete: cascade]
Ref: project_file.project_id > project.id [delete: cascade]
Ref: project_image.project_id > project.id [delete: cascade]
Ref: project_link.project_id > project.id [delete: cascade]
Ref: tool_material.project_id > project.id [delete: cascade]

// Notes
// pageview table tracks all page visits for analytics
// Materialized view page_view_counts aggregates view counts by URL for performance (requires manual refresh)
// View top_viewed_pages shows the top 10 most viewed pages ordered by view count (queries pageview table directly for real-time data)
