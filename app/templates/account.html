{% extends "base.html" %}
{% block title %}My Account{% endblock %}
{% block content %}
<div class="container my-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0"><i class="fas fa-user-circle me-3 kevred"></i>My Account</h3>
        {% if user.type == 1 %}
        <a href="/admin" class="btn btn-danger">
          <i class="fa-solid fa-user-shield me-2"></i>Admin Panel
        </a>
        {% endif %}
      </div>

      <!-- Update Profile -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-card-blue text-white">
          <h5 class="mb-0"><i class="fas fa-user-edit me-3"></i>Update Profile</h5>
        </div>
        <div class="card-body p-4">
          {% if update_success %}
          <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>{{ update_success }}
          </div>
          {% endif %}
          {% if update_error %}
          <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>{{ update_error }}
          </div>
          {% endif %}

          <!-- Profile Picture -->
          <div class="mb-4">
            <label class="form-label fw-bold">Profile Picture</label>
            <div class="d-flex align-items-center gap-3">
              <div id="profile-picture-preview">
                {% if user.profile_picture %}
                <img src="https://chatter.kevsrobots.com/profile_pictures/{{ user.profile_picture }}" alt="Profile" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                {% else %}
                <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center text-white" style="width: 100px; height: 100px; font-size: 2rem;">
                  {{ user.username[0]|upper }}
                </div>
                {% endif %}
              </div>
              <div>
                <button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('profile-picture-input').click()">
                  <i class="fas fa-upload me-1"></i>Upload Picture
                </button>
                {% if user.profile_picture %}
                <button type="button" class="btn btn-sm btn-danger" onclick="deleteProfilePicture()">
                  <i class="fas fa-trash me-1"></i>Remove
                </button>
                {% endif %}
                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" onchange="uploadProfilePicture()">
                <div id="upload-status" class="mt-2"></div>
                <small class="text-muted d-block mt-1">Max 5MB. Will be resized to 400x400px.</small>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Username</label>
            <p class="form-control-plaintext fw-bold text-muted">{{ user.username }}</p>
            <small class="text-muted">Username cannot be changed</small>
          </div>

          <form method="post" action="/account/update">
            <div class="mb-3">
              <label for="email" class="form-label fw-bold">Email</label>
              <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
            </div>

            <div class="mb-3">
              <label for="location" class="form-label fw-bold">Location</label>
              <input type="text" class="form-control" id="location" name="location" value="{{ user.location or '' }}" placeholder="e.g., United Kingdom">
              <small class="text-muted">Your location helps with timezone/localization</small>
            </div>

            <div class="mb-3">
              <label for="bio" class="form-label fw-bold">Bio</label>
              <textarea class="form-control" id="bio" name="bio" rows="3" maxlength="500" placeholder="Tell us about yourself...">{{ user.bio or '' }}</textarea>
              <small class="text-muted">Max 500 characters</small>
            </div>

            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Update Profile
            </button>
          </form>
        </div>
      </div>

      <!-- Change Password -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-card-orange text-white">
          <h5 class="mb-0"><i class="fas fa-key me-3"></i>Change Password</h5>
        </div>
        <div class="card-body p-4">
          {% if password_success %}
          <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>{{ password_success }}
          </div>
          {% endif %}
          {% if password_error %}
          <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>{{ password_error }}
          </div>
          {% endif %}

          <form method="post" action="/account/change-password">
            <div class="mb-3">
              <label for="current_password" class="form-label fw-bold">Current Password</label>
              <input type="password" class="form-control" id="current_password" name="current_password" required>
            </div>
            <div class="mb-3">
              <label for="new_password" class="form-label fw-bold">New Password</label>
              <input type="password" class="form-control" id="new_password" name="new_password" required minlength="8">
              <small class="form-text text-muted">Minimum 8 characters with uppercase, lowercase, and numbers</small>
            </div>
            <button type="submit" class="btn btn-warning">
              <i class="fas fa-lock me-2"></i>Change Password
            </button>
          </form>
        </div>
      </div>

      <!-- Activity Stats -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-heart fa-3x kevred mb-3"></i>
              <h3 class="mb-0">{{ like_count }}</h3>
              <p class="text-muted mb-0">Total Likes</p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-comments fa-3x text-primary mb-3"></i>
              <h3 class="mb-0">{{ comments|length }}</h3>
              <p class="text-muted mb-0">Comments</p>
            </div>
          </div>
        </div>
      </div>

      <!-- My Comments -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-card-green text-white">
          <h5 class="mb-0"><i class="fas fa-comment me-3"></i>My Comments</h5>
        </div>
        <div class="card-body p-4">
          {% if comments %}
          <div class="list-group">
            {% for comment in comments %}
            <div class="list-group-item">
              <p class="mb-1">{{ comment.content }}</p>
              <small class="text-muted">
                <i class="fas fa-link me-1"></i>
                <a href="{{ comment.url }}" target="_blank" class="text-decoration-none">{{ comment.url }}</a>
              </small>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">You haven't made any comments yet.</p>
          {% endif %}
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="card shadow-sm border-danger">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-3"></i>Danger Zone</h5>
        </div>
        <div class="card-body p-4">
          <p class="text-muted mb-3">
            Once you delete your account, there is no going back. Please be certain.
          </p>
          <form method="post" action="/account/delete">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete your account? This cannot be undone.')">
              <i class="fas fa-trash-alt me-2"></i>Delete My Account
            </button>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
async function uploadProfilePicture() {
  const fileInput = document.getElementById('profile-picture-input');
  const statusDiv = document.getElementById('upload-status');
  const file = fileInput.files[0];

  if (!file) return;

  // Validate file size (5MB)
  if (file.size > 5 * 1024 * 1024) {
    statusDiv.innerHTML = '<div class="alert alert-danger alert-sm">File too large. Max 5MB.</div>';
    return;
  }

  statusDiv.innerHTML = '<div class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Uploading...</div>';

  const formData = new FormData();
  formData.append('file', file);

  try {
    const response = await fetch('https://chatter.kevsrobots.com/profile/picture', {
      method: 'POST',
      credentials: 'include',
      body: formData
    });

    const data = await response.json();

    if (response.ok) {
      statusDiv.innerHTML = '<div class="alert alert-success alert-sm">Picture uploaded successfully!</div>';
      // Reload page to show new picture
      setTimeout(() => window.location.reload(), 1000);
    } else if (response.status === 401) {
      // Authentication error - redirect to login
      window.location.href = '/login?return_to=/account';
      return;
    } else {
      statusDiv.innerHTML = `<div class="alert alert-danger alert-sm">${data.detail || 'Upload failed'}</div>`;
    }
  } catch (error) {
    console.error('Upload error:', error);
    statusDiv.innerHTML = '<div class="alert alert-danger alert-sm">Upload failed. Please try again.</div>';
  }
}

async function deleteProfilePicture() {
  if (!confirm('Are you sure you want to remove your profile picture?')) {
    return;
  }

  const statusDiv = document.getElementById('upload-status');
  statusDiv.innerHTML = '<div class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Removing...</div>';

  try {
    const response = await fetch('https://chatter.kevsrobots.com/profile/picture', {
      method: 'DELETE',
      credentials: 'include'
    });

    const data = await response.json();

    if (response.ok) {
      statusDiv.innerHTML = '<div class="alert alert-success alert-sm">Picture removed successfully!</div>';
      // Reload page to show default avatar
      setTimeout(() => window.location.reload(), 1000);
    } else if (response.status === 401) {
      // Authentication error - redirect to login
      window.location.href = '/login?return_to=/account';
      return;
    } else {
      statusDiv.innerHTML = `<div class="alert alert-danger alert-sm">${data.detail || 'Delete failed'}</div>`;
    }
  } catch (error) {
    console.error('Delete error:', error);
    statusDiv.innerHTML = '<div class="alert alert-danger alert-sm">Delete failed. Please try again.</div>';
  }
}
</script>
{% endblock %}
